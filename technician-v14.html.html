<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fix-Flow | ระบบช่าง (v14.0 Production)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* (CSS ทั้งหมดจาก v13.0 อยู่ตรงนี้) */
    </style>
</head>
<body>
<div id="app">
    </div>
<script>
    const { createApp, ref, reactive, computed, onMounted, watch, nextTick } = Vue;
    const { createClient } = supabase;

    // --- Developer ต้องกรอกข้อมูลนี้ ---
    const SUPABASE_URL = 'https://wcgcjganvyyyaiaordyc.supabase.co'; // ใส่ URL ของ Supabase ที่นี่
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndjZ2NqZ2Fudnl5eWFpYW9yZHljIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIxNjQxMDcsImV4cCI6MjA3Nzc0MDEwN30.r6izWCmfPCeIt0U4429DnzBiPsZFjSR8YJB--OlDBUU'; // ใส่ Key ของ Supabase ที่นี่
    // ---------------------------------

    if (SUPABASE_URL === 'YOUR_SUPABASE_URL') {
        alert('Developer: กรุณาตั้งค่า SUPABASE_URL และ SUPABASE_KEY ในไฟล์ technician-v14.html');
    }
    const db = createClient(SUPABASE_URL, SUPABASE_KEY);

    const App = {
        setup() {
            const state = reactive({
                isLoggedIn: false, currentView: 'jobPool', tickets: [], technicians: [],
                currentTechnicianId: null, solutionImageUrl: null, file: null,
                chartInstances: {}, 
            });

            const loadData = async () => {
                const { data, error } = await db.from('tickets').select('*').order('created_at', { ascending: false });
                if (error) console.error('Error loading tickets:', error);
                else state.tickets = data;
                
                // Load technicians once on login
                if (state.isLoggedIn && state.technicians.length === 0) {
                     const { data: techs } = await db.from('technicians').select('*');
                     state.technicians = techs || [];
                }
            };

            const claimJob = async (ticketId) => {
                const tech = state.technicians.find(t => t.id === state.currentTechnicianId);
                const { data, error } = await db
                    .from('tickets')
                    .update({ status: 'In Progress', assignee_id: tech.id, assignee_name: tech.name })
                    .eq('id', ticketId);
                if (error) alert('Error claiming job: ' + error.message);
                else loadData(); // Reload all data
            };

            const handleSolutionImageUpload = (event) => {
                state.file = event.target.files[0];
                if (state.file) {
                    if (state.file.size > 2 * 1024 * 1024) { /* ... (File size check) ... */ }
                    state.solutionImageUrl = URL.createObjectURL(state.file); // Local preview
                }
            };

             const completeJob = async (jobId) => {
                if (!state.file) { alert('กรุณาอัปโหลดรูปซ่อมเสร็จ'); return; }
                let solution_image_url = null;

                try {
                    // 1. Upload image
                    const filePath = `solutions/${Date.now()}-${state.file.name}`;
                    const { error: uploadError } = await db.storage.from('images').upload(filePath, state.file);
                    if (uploadError) throw uploadError;

                    // 2. Get URL
                    const { data: urlData } = db.storage.from('images').getPublicUrl(filePath);
                    solution_image_url = urlData.publicUrl;
                    
                    // 3. Update ticket
                    const { error: updateError } = await db
                        .from('tickets')
                        .update({ status: 'Completed', solution_image_url: solution_image_url })
                        .eq('id', jobId);
                    if (updateError) throw updateError;
                    
                    loadData(); // Reload all data
                    state.solutionImageUrl = null;
                    state.file = null;

                } catch (error) {
                    alert('Error completing job: ' + error.message);
                }
            };

            const login = (id) => {
                state.isLoggedIn = true;
                state.currentTechnicianId = id;
                loadData();
            };

            // --- Computed Properties ---
            const unassignedJobs = computed(() => state.tickets.filter(t => t.status === 'Pending'));
            const myJobs = computed(() => state.tickets.filter(t => t.assigneeId === state.currentTechnicianId));
            const currentTechnicianName = computed(() => state.technicians.find(t => t.id === state.currentTechnicianId)?.name);
            // ... (All other computed properties for dashboard) ...

            // --- Watchers & Lifecycle ---
            watch(() => state.currentView, (newView) => {
                 if (newView === 'summary') {
                    nextTick(() => { /* ... (Call render charts methods) ... */ });
                }
            });
            onMounted(() => {
                // Do not load data on mount, wait for login
                // Set up real-time listener for new tickets
                db.channel('public:tickets')
                    .on('postgres_changes', { event: '*', schema: 'public', table: 'tickets' }, 
                        (payload) => {
                            console.log('Change received!', payload);
                            loadData(); // Reload all data on any change
                        }
                    )
                    .subscribe();
            });

            // --- Chart Methods (same as v13.0) ---
            const renderChart = (chartId, type, data, options = {}) => { /* ... */ };
            const renderTrendChart = () => { /* ... */ };
            const renderTechnicianChart = () => { /* ... */ };
            const renderCategoryChart = () => { /* ... */ };

            return { 
                state, unassignedJobs, myJobs, currentTechnicianName,
                login, claimJob, handleSolutionImageUpload, completeJob,
                /* ... (return all computed properties for dashboard) ... */
            };
        },
        template: `
            `
    };
    createApp(App).mount('#app');
</script>
</body>
</html>